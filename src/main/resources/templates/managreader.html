<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head th:replace="header :: head(~{::title},~{::style})">
    <title>读者管理</title>

    <style>
.error{
    color: red;
    font-size: 20px;
    font-family: "Arial Narrow";
}
    </style>

</head>

<body>


<nav th:replace="header :: header"></nav>

<div class="panel panel-default">
    <div class="panel-heading">读者管理</div>
    <div class="panel-body">
        <a class="btn btn-success btn-sm" data-toggle="modal" data-target="#addModal" >新建读者</a>
        <table id="reader_table">
        </table>

    </div>
</div>


<div class="modal fade" id="addModal" tabindex="-1" role="dialog" aria-labelledby="myModalLabel">
    <div class="modal-dialog" role="document">
        <div class="modal-content">
            <div class="modal-header">
                <button type="button" class="close" data-dismiss="modal" aria-label="Close"><span aria-hidden="true">&times;</span></button>
                <h4 class="modal-title">新建读者</h4>
            </div>
            <div class="modal-body">
                <form class="form-horizontal" id="addform">
                    <div class="form-group">
                        <label class="control-label col-sm-2" for="studentId">学生号</label>
                        <div class="col-sm-10">
                            <input type="text" class="form-control" id="studentId" placeholder="输入学生号" name="studentId">
                        </div>
                    </div>
                    <div class="form-group">
                        <label class="control-label col-sm-2" for="cardId">身份证</label>
                        <div class="col-sm-10">
                            <input type="text" class="form-control" id="cardId" placeholder="输入身份证" name="cardId">
                        </div>
                    </div>
                    <div class="form-group">
                        <label class="control-label col-sm-2" for="name">姓名：</label>
                        <div class="col-sm-10">
                            <input type="text" class="form-control" id="name" placeholder="输入姓名" name="name">
                        </div>
                    </div>
                    <div class="form-group">
                        <label class="control-label col-sm-2" for="college">学院：</label>
                        <div class="col-sm-10">
                            <select class="form-control" id="college" name="college">
                                <option value="无">无</option>
                                <option value="医学部">医学部</option>
                                <option value="冶金与能源工程学院">冶金与能源工程学院</option>
                                <option value="生命科学与技术学院">生命科学与技术学院</option>
                                <option value="环境科学与工程学院">环境科学与工程学院</option>
                                <option value="材料科学与工程学院">材料科学与工程学院</option>
                                <option value="国土资源工程学院">国土资源工程学院</option>
                                <option value="机电工程学院">机电工程学院</option>
                                <option value="信息工程与自动化学院（人工智能产业学院）">信息工程与自动化学院（人工智能产业学院）</option>
                                <option value="建筑工程学院">建筑工程学院</option>
                                <option value="建筑与城市规划学院">建筑与城市规划学院</option>
                                <option value="化学工程学院">化学工程学院</option>
                                <option value="交通工程学院">交通工程学院</option>
                                <option value="电力工程学院">电力工程学院</option>
                                <option value="民航与航空学院">民航与航空学院</option>
                                <option value="公共安全与应急管理学院">公共安全与应急管理学院</option>
                                <option value="现代农业工程学院">现代农业工程学院</option>
                                <option value="食品科学与工程学院">食品科学与工程学院</option>
                                <option value="管理与经济学院">管理与经济学院</option>
                                <option value="理学院">理学院</option>
                                <option value="基础医学院">基础医学院</option>
                                <option value="法学院">法学院</option>
                                <option value="艺术与传媒学院">艺术与传媒学院</option>
                                <option value="马克思主义学院">马克思主义学院</option>
                                <option value="外国语言文化学院">外国语言文化学院</option>
                                <option value="城市学院">城市学院</option>
                                <option value="国际学院">国际学院</option>
                                <option value="体育学院">体育学院</option>
                                <option value="继续教育学院">继续教育学院</option>
                                <option value="云南工业干部培训基地">云南工业干部培训基地</option>
                                <option value="灵长类转化医学研究院">灵长类转化医学研究院</option>
                            </select>
                        </div>
                    </div>

                    <div class="form-group">
                        <label class="control-label col-sm-2" for="major">专业：</label>
                        <div class="col-sm-10">
                            <input type="text" class="form-control" id="major" placeholder="输入专业" name="major">
                        </div>
                    </div>
                    <div class="form-group">
                        <label class="control-label col-sm-2" for="grade">年级：</label>
                        <div class="col-sm-10">
                            <input type="text" class="form-control" id="grade" placeholder="输入年级" name="grade">
                        </div>
                    </div>
                    <div class="form-group">
                        <label class="control-label col-sm-2" for="phone">电话：</label>
                        <div class="col-sm-10">
                            <input type="text" class="form-control" id="phone" placeholder="输入电话" name="phone">
                        </div>
                    </div>
                    <div class="form-group">
                        <label class="control-label col-sm-2" for="graduation">毕业：</label>
                        <div class="col-sm-10">
                            <input type="checkbox" id="graduation" name="graduation"> 已毕业
                        </div>
                    </div>

                    <div class="modal-footer">
                        <button type="button" class="btn btn-default" data-dismiss="modal">关闭</button>
                        <div class="btn btn-primary" id="addbtn">提交</div>
                    </div>
                    <div class="error" id="error-msg">

                    </div>
                </form>

            </div>

        </div>
    </div>
</div>

<div class="modal fade" id="book_record" tabindex="-1" role="dialog" aria-labelledby="myModalLabel">
    <div class="modal-dialog" role="document" style="width: 80%">
        <div class="modal-content">
            <div class="modal-header">
                <button type="button" class="close" data-dismiss="modal" aria-label="Close"><span aria-hidden="true">&times;</span></button>
                <h4 class="modal-title">借阅详情</h4>
            </div>
            <div class="modal-body">
                <table class="table table-bordered table-hover">
                    <thead>
                    <th>图书ID</th>
                    <th>书名</th>
                    <th>借阅时间</th>
                    <th>预定归还时间</th>
                    <th>归还时间</th>
                    <th>是否逾期</th>
                    <th>是否归还</th>

                    </thead>
                    <tbody id="record_tbody">

                    </tbody>
                </table>

                <div class="modal-footer">
                    <button type="button" class="btn btn-default" data-dismiss="modal">关闭</button>
                </div>
            </div>
        </div>
    </div>


</div>

<div class="modal fade" id="update_Modal" tabindex="-1" role="dialog" aria-labelledby="myModalLabel">
    <div class="modal-dialog" role="document" style="width: 80%">
        <div class="modal-content">
            <div class="modal-header">
                <button type="button" class="close" data-dismiss="modal" aria-label="Close"><span aria-hidden="true">&times;</span></button>
                <h4 class="modal-title">更新</h4>
            </div>
            <div class="modal-body">
                <form class="form-horizontal" id="updateform">
                    <div class="form-group">
                        <label class="control-label col-sm-2" for="studentId">学生号</label>
                        <div class="col-sm-10">
                            <input type="text" class="form-control"  placeholder="输入学生号" name="studentId">
                        </div>
                    </div>
                    <div class="form-group">
                        <label class="control-label col-sm-2" for="cardId">身份证</label>
                        <div class="col-sm-10">
                            <input type="text" class="form-control" placeholder="输入身份证" name="cardId">
                        </div>
                    </div>
                    <div class="form-group">
                        <label class="control-label col-sm-2" for="name">姓名：</label>
                        <div class="col-sm-10">
                            <input type="text" class="form-control"  placeholder="输入姓名" name="name">
                        </div>
                    </div>
                    <div class="form-group">
                        <label class="control-label col-sm-2" for="college">学院：</label>
                        <div class="col-sm-10">
                            <select class="form-control"  name="college">
                                <option value="">无</option>
                                <option value="医学部">医学部</option>
                                <option value="冶金与能源工程学院">冶金与能源工程学院</option>
                                <option value="生命科学与技术学院">生命科学与技术学院</option>
                                <option value="环境科学与工程学院">环境科学与工程学院</option>
                                <option value="材料科学与工程学院">材料科学与工程学院</option>
                                <option value="国土资源工程学院">国土资源工程学院</option>
                                <option value="机电工程学院">机电工程学院</option>
                                <option value="信息工程与自动化学院（人工智能产业学院）">信息工程与自动化学院（人工智能产业学院）</option>
                                <option value="建筑工程学院">建筑工程学院</option>
                                <option value="建筑与城市规划学院">建筑与城市规划学院</option>
                                <option value="化学工程学院">化学工程学院</option>
                                <option value="交通工程学院">交通工程学院</option>
                                <option value="电力工程学院">电力工程学院</option>
                                <option value="民航与航空学院">民航与航空学院</option>
                                <option value="公共安全与应急管理学院">公共安全与应急管理学院</option>
                                <option value="现代农业工程学院">现代农业工程学院</option>
                                <option value="食品科学与工程学院">食品科学与工程学院</option>
                                <option value="管理与经济学院">管理与经济学院</option>
                                <option value="理学院">理学院</option>
                                <option value="基础医学院">基础医学院</option>
                                <option value="法学院">法学院</option>
                                <option value="艺术与传媒学院">艺术与传媒学院</option>
                                <option value="马克思主义学院">马克思主义学院</option>
                                <option value="外国语言文化学院">外国语言文化学院</option>
                                <option value="城市学院">城市学院</option>
                                <option value="国际学院">国际学院</option>
                                <option value="体育学院">体育学院</option>
                                <option value="继续教育学院">继续教育学院</option>
                                <option value="云南工业干部培训基地">云南工业干部培训基地</option>
                                <option value="灵长类转化医学研究院">灵长类转化医学研究院</option>
                            </select>
                        </div>
                    </div>

                    <div class="form-group">
                        <label class="control-label col-sm-2" for="major">专业：</label>
                        <div class="col-sm-10">
                            <input type="text" class="form-control" placeholder="输入专业" name="major">
                        </div>
                    </div>
                    <div class="form-group">
                        <label class="control-label col-sm-2" for="grade">年级：</label>
                        <div class="col-sm-10">
                            <input type="text" class="form-control"  placeholder="输入年级" name="grade">
                        </div>
                    </div>
                    <div class="form-group">
                        <label class="control-label col-sm-2" for="phone">电话：</label>
                        <div class="col-sm-10">
                            <input type="text" class="form-control"  placeholder="输入电话" name="phone">
                        </div>
                    </div>
                    <div class="form-group">
                        <label class="control-label col-sm-2" for="graduation">毕业：</label>
                        <div class="col-sm-10">
                            <input type="checkbox"  name="graduation" required> 已毕业
                        </div>
                    </div>
                </form>
                <div class="error" id="update_error_msg">
                </div>
                <div class="modal-footer">
                    <button class="btn btn-success" id="update_btn">更新</button>
                    <button type="button" class="btn btn-default" data-dismiss="modal">关闭</button>
                </div>
            </div>
        </div>
    </div>


</div>




<script>
    $(document).ready(function() {
        bindClickSubmit();
        inittablebooklist();
        initupdatereader()


    });
    var bookid;
    var readerid;

    function initupdatereader() {
        msg=$("#error-msg");
        $("#update_btn").click(
            function(){
                url='reader_update?id='+readerid;
                $.ajax({
                    url: url,
                    type: "POST",
                    data: $('#updateform').serialize(),
                    dataType: "JSON",
                    success: function(res) {
                        if (res['status']) {
                            location.reload()
                        } else {
                            // alert(res)
                            msg.text(res.msg);
                        }
                    },

                });
            }
        )

    }

    function bindClickSubmit() {
        $("#addbtn").click(function() {
            msg=$("#error-msg");
            $.ajax({
                url: "/reader_add",
                type: "POST",
                data: $('#addform').serialize(),
                dataType: "JSON",
                success: function(res) {
                    if (res['status']) {
                        location.reload()
                    } else {
                        msg.text(res.msg);
                        // alert(res)

                    }
                },

            });
        });

    }
    // 格式化日期函数
    function formatDate(isoDateString) {
        if(isoDateString){
            var date=new Date(isoDateString);
            var year = date.getFullYear();
            var month = String(date.getMonth() + 1).padStart(2, '0');
            var day = String(date.getDate()).padStart(2, '0');
            var houer=String(date.getHours()).padStart(2,'0');
            var min=String(date.getMinutes()).padStart(2,'0');

            return year + '-' + month + '-' + day + " " +houer+":"+min;}
        else {
            return ''
        }
    }


    function inittablebooklist() {
        url=window.document.location.href;

        window.operateEvents = {
            "click #valid_btn":function (e,value,row,index) {
                url="/reader_active?id="+row.id;
                $.ajax({
                    url: url,
                    type: "POST",
                    success: function(res) {
                        if (res['status']) {
                            location.reload()
                        } else {
                            alert(res)

                        }
                    },

                });

            },
            "click #update_reader":function (e,value,row,index) {
                // 赋值表单
                readerid=row.id;
                $.each(row, function(key, value) {
                    var input = $('#updateform [name=' + key + ']');
                    if (input.is("input, textarea,number,checkbox")) {
                        input.val(value);
                    }
                });

            },

            "click #reader_cord_info":function (e,value,row,index) {

                var url="/record?reader_id="+row.id;
                var record_tbody=$("#record_tbody")
                record_tbody.empty();
                $.ajax({
                    url:url,
                    type:"POST",
                    dataType:"JSON",
                    success:function(res){
                        if(res.status){
                            data=res.data;
                            if(data){
                                var html="";
                                for(var i=0;i<data.length;i++){
                                    html+="<tr>";
                                    html+="<td>"+data[i].book.id+"</td>";
                                    html+="<td>"+data[i].book.title+"</td>";
                                    html+="<td>"+formatDate(data[i].createTime)+"</td>";
                                    html+="<td>"+data[i].returnDate+"</td>";
                                    html+="<td>"+formatDate(data[i].actualReturnDate)+"</td>";
                                    var overdue=data[i].overdue
                                    if(overdue) {
                                        html += '<td><span class="label label-danger">已逾期</span></td>';
                                    }
                                    else {
                                        html += '<td><span class="label label-primary">未逾期</span></td>';
                                    }
                                    var ifreturn=data[i].return;
                                    if(ifreturn){
                                        html += '<td><span class="label label-success">已归还</span></td>';
                                    }
                                    else {
                                        html += '<td><span class="label label-info">未归还</span></td>';
                                    }
                                    html+="</tr>";

                                }
                                record_tbody.html(html);
                            }

                        }

                        else {
                            // alert(res)
                        }
                    }
                });

            },

            "click #delete_status_btn":function (e,value,row,index) {
                url="/book_active?id="+row.id;
                $.ajax({
                    url: url,
                    type: "POST",
                    success: function(res) {
                        if (res['status']) {
                            location.reload()
                        } else {
                            alert(res)

                        }
                    },

                });

            },


            // 当点击 class=delete 时触发
            "click .delete": function (e,value,row,index) {
                result=confirm("是否确认删除?")
                if(result){
                var id=row.id;
                $.ajax({
                    url: "/reader_delete",
                    type: "POST",
                    data: {id:id},
                    dataType: "JSON",
                    success: function(res) {
                        if (res['status']) {
                            location.reload();
                        } else {
                            alert(res.data)
                        }
                    },

                });}
            },

        };

        $('#reader_table').bootstrapTable({
            url: url,         //请求后台的 URL（*）
            method: 'post',                      //请求方式（*）

            toolbar: '#toolbar',                //工具按钮用哪个容器
            sidePagination:'client',//server:服务器端分页|client：前端分页
            responseHandler: function (res) {
                // 处理响应数据格式
                return {
                    rows: res.data// 数据行
                };
            },

            striped: true,                      //是否显示行间隔色
            cache: true,                       //是否使用缓存，默认为 true，所以一般情况下需要设置一下这个属性（*）
            pagination: true,                   //是否显示分页（*）
            sortable: false,                    //是否启用排序
            sortOrder: "desc",                 //排序方式

            pageNumber:1,                       //初始化加载第一页，默认第一页
            pageSize: 20,                        //每页的记录行数（*）
            pageList: [20],        //可供选择的每页的行数（*）
            search: true,                       //是否显示表格搜索，此搜索是客户端搜索，不会进服务端，所以个人感觉意义不大
            strictSearch: true,                 //启用严格搜索。禁用比较检查。
            showColumns: true,                  //是否显示所有的列
            showRefresh: true,                  //是否显示刷新按钮
            minimumCountColumns: 2,             //最少允许的列数
            clickToSelect: true,                //是否启用点击选中行
            height: 700,                        //行高，如果没有设置 height 属性，表格自动根据记录条数觉得表格高度
            uniqueId: "ID",                     //每一行的唯一标识，一般为主键列
            showToggle:true,                    //是否显示详细视图和列表视图的切换按钮
            cardView: false,                    //是否显示详细视图
            detailView: false,                  //是否显示父子表
            showExport: true,                   //是否显示导出
            exportDataType: "basic",            //basic', 'all', 'selected'.
            columns: [{
                checkbox: true     //复选框标题，就是我们看到可以通过复选框选择整行。
            },
                {
                    field: 'id',
                    title: 'ID',

                },
                {
                    field: 'name',
                    title: '姓名'
                },

                {
                    field: 'studentId',
                    title: '学号',
                },
                {
                    field: 'cardId',
                    title: '身份证号'
                },
                {
                    field: 'phone',
                    title: '电话号码'
                },
                {
                    field: 'major',
                    title: '专业'
                },
                {
                    field: 'grade',
                    title: '年级'
                },
                {
                    field: 'college',
                    title: '学院'
                },

                {
                    field: "createTime",
                    title: "创建时间",
                    formatter:function ( value,row,index) {
                        return formatDate(row.createTime);

                    }
                },
                {
                    field: 'Button',title:"毕业",align: 'center',events: operateEvents,formatter:function(value,row,index){
                        if(row.graduation){
                            var btn = '<span class="label label-default">已毕业</span>'
                        }
                        else {
                            var btn = '<span class="label label-primary">未毕业</span>'
                        }

                        return [btn]
                    }
                },
                {
                    field: 'Button4',title:"状态",align: 'center',formatter:function(value,row,index){

                        if(row.valid){
                        btn='<span class="label label-success">账号正常</span>'
                        }
                        else {
                        btn='<span class="label label-default">账号无效</span>'
                        }

                        return [btn]
                    }
                },
                {
                    field: 'Button2',title:"生效",align: 'center',events: operateEvents,formatter:function(value,row,index){

                        if(row.valid){
                            var btn='<button type="button" class="btn btn-default" style="margin: 5px"   id="valid_btn">注销</button>'
                        }
                        else {
                            var btn='<button type="button"  class="btn btn-success" style="margin: 5px"  id="valid_btn">激活</button>'
                        }

                        return [btn]
                    }
                },

                {
                    field: 'Button3',title:"操作",align: 'center',events: operateEvents,formatter:function(value,row,index){

                        var search = '<div type="button" class="btn btn-info search" style="margin: 5px" id="reader_cord_info" data-target="#book_record" data-toggle="modal" >借书详情('+row.borrowCount+')</div>';
                        var del = '<button type="button"  class="btn btn-warning delete" style="margin: 5px" id="delete_reader">删除</button>'
                        var update = '<button type="button"  class="btn btn-primary" style="margin: 5px" id="update_reader" data-toggle="modal" data-target="#update_Modal">更新</button>'
                        return [del,search,update].join('')
                    }
                }
            ],

        });

    }

</script>

<script th:replace="header :: searchscript"></script>
</body>
</html>